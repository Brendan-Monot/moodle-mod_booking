{"version":3,"file":"subbookingAdditionalPerson.min.js","sources":["../../src/condition/subbookingAdditionalPerson.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * @module     mod_booking/condition/subbookingAdditionalPerson\r\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\nimport DynamicForm from 'core_form/dynamicform';\r\nimport {initbookitbutton} from 'mod_booking/bookit';\r\nimport {eventTypes} from 'core_filters/events';\r\n\r\nconst SELECTOR = {\r\n    FORMCONTAINER: '.subbooking-additionalperson-form',\r\n    MODALBODY: '.prepage-body',\r\n    CONTINUECONTAINER: ' div.prepage-booking-footer .continue-container',\r\n    CONTINUEBUTTON: ' div.prepage-booking-footer .continue-button',\r\n    BOOKINGBUTTON: '[data-area=\"subbooking\"][data-userid][data-itemid=\"',\r\n};\r\n\r\n/**\r\n * Init function.\r\n * @param {boolean} shoppingcartisinstalled\r\n */\r\nexport async function init(shoppingcartisinstalled) {\r\n\r\n    // eslint-disable-next-line no-console\r\n    console.log('init dynamic form');\r\n\r\n    const containers = document.querySelectorAll(SELECTOR.FORMCONTAINER);\r\n\r\n    containers.forEach(async container => {\r\n        const id = container.dataset.id;\r\n\r\n        const continuebutton = container.closest(SELECTOR.MODALBODY).querySelector(SELECTOR.CONTINUEBUTTON);\r\n        const dynamicForm = new DynamicForm(container, 'mod_booking\\\\form\\\\subbooking\\\\additionalperson_form');\r\n\r\n        // We need to render the dynamic form right away, so we can acutally have all the necessary elements present.\r\n        await dynamicForm.load({id: id});\r\n\r\n        const bookitbutton = container.closest(SELECTOR.MODALBODY).querySelector(SELECTOR.BOOKINGBUTTON + id);\r\n\r\n        // eslint-disable-next-line no-console\r\n        console.log(bookitbutton, continuebutton);\r\n\r\n        dynamicForm.addEventListener(dynamicForm.events.FORM_SUBMITTED, e => {\r\n            const response = e.detail;\r\n\r\n            if (response) {\r\n\r\n                unblockButtons(id, container);\r\n\r\n                dynamicForm.load({id: id});\r\n            }\r\n        });\r\n\r\n        document.addEventListener(eventTypes.filterContentUpdated, e => {\r\n            // eslint-disable-next-line no-console\r\n            console.log(e.target);\r\n\r\n            initButtons(id, container, dynamicForm, shoppingcartisinstalled);\r\n        });\r\n\r\n        dynamicForm.addEventListener(dynamicForm.events.SERVER_VALIDATION_ERROR, () => {\r\n\r\n            // eslint-disable-next-line no-console\r\n            console.log('error with form');\r\n\r\n            initButtons(id, container, dynamicForm, shoppingcartisinstalled);\r\n        });\r\n\r\n        dynamicForm.addEventListener('change', e => {\r\n\r\n            if (e.target.classList.contains('custom-select')) {\r\n                const button = document.querySelector('.subbooking-additionalperson-form [data-no-submit=\"1\"]');\r\n                dynamicForm.processNoSubmitButton(button);\r\n            }\r\n        });\r\n\r\n        initButtons(id, container, dynamicForm, shoppingcartisinstalled);\r\n    });\r\n}\r\n\r\n/**\r\n * @param {integer} id\r\n * @param {HTMLElement} container\r\n * @param {*} dynamicForm\r\n * @param {boolean} shoppingcartisinstalled\r\n */\r\nfunction initButtons(id, container, dynamicForm, shoppingcartisinstalled) {\r\n\r\n    // We always need to get the buttons anew, as they might have been replaced.\r\n\r\n    const prepagemodal = container.closest(SELECTOR.MODALBODY);\r\n\r\n    if (!prepagemodal) {\r\n        return;\r\n    }\r\n\r\n    const bookitbutton = prepagemodal.querySelector(SELECTOR.BOOKINGBUTTON + id);\r\n\r\n    // This goes on the bookit button as well as on the shopping cart.\r\n    // It will prevent the action to be triggered.\r\n    // Unless the form is validated (see above).\r\n    if (bookitbutton) {\r\n\r\n        // eslint-disable-next-line no-console\r\n        console.log('bookitbutton', bookitbutton);\r\n\r\n        blockButton(bookitbutton, dynamicForm);\r\n    }\r\n\r\n    // Only after the Form is loaded, we reinitialze the buttons.\r\n    try {\r\n        // Avoid any errors/warnings if no shopping_cart installed.\r\n        if (shoppingcartisinstalled) {\r\n            import('local_shopping_cart/cart')\r\n                    // eslint-disable-next-line promise/always-return\r\n                    .then(shoppingcart => {\r\n                        shoppingcart.buttoninit();\r\n                    })\r\n                    .catch(err => {\r\n                        // Handle any errors, including if the module doesn't exist\r\n                        // eslint-disable-next-line no-console\r\n                        console.log(err);\r\n                });\r\n            }\r\n        initbookitbutton();\r\n    } catch (e) {\r\n        // eslint-disable-next-line no-console\r\n        console.log(e);\r\n    }\r\n}\r\n\r\n/**\r\n *\r\n * @param {HTMLElement} button\r\n * @param {*} dynamicForm\r\n */\r\nfunction blockButton(button, dynamicForm) {\r\n\r\n    // eslint-disable-next-line no-console\r\n    console.log('blockButton', button);\r\n\r\n    if (!button.dataset.blocked) {\r\n        button.dataset.blocked = true;\r\n\r\n         // eslint-disable-next-line no-console\r\n        console.log('blockButton add listener', button);\r\n\r\n        button.addEventListener('click', () => {\r\n\r\n            // eslint-disable-next-line no-console\r\n            console.log('click');\r\n\r\n            dynamicForm.submitFormAjax();\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n *\r\n * @param {integer} id\r\n * @param {HTMLElement} container\r\n */\r\nfunction unblockButtons(id, container) {\r\n\r\n    // We always need to get the buttons anew, as they might have been replaced.\r\n\r\n    const bookitbutton = container.closest(SELECTOR.MODALBODY).querySelector(SELECTOR.BOOKINGBUTTON + id);\r\n\r\n    if (bookitbutton) {\r\n        bookitbutton.dataset.blocked = 'false';\r\n    }\r\n}\r\n\r\n"],"names":["obj","async","shoppingcartisinstalled","console","log","document","querySelectorAll","SELECTOR","FORMCONTAINER","forEach","id","container","dataset","continuebutton","closest","MODALBODY","querySelector","CONTINUEBUTTON","dynamicForm","DynamicForm","load","bookitbutton","BOOKINGBUTTON","addEventListener","events","FORM_SUBMITTED","e","detail","blocked","unblockButtons","eventTypes","filterContentUpdated","target","initButtons","SERVER_VALIDATION_ERROR","classList","contains","button","processNoSubmitButton","_dynamicform","__esModule","default","_systemImportTransformerGlobalIdentifier","window","self","global","CONTINUECONTAINER","prepagemodal","submitFormAjax","blockButton","define","amd","Promise","resolve","reject","require","module","exports","component","loader","then","shoppingcart","buttoninit","catch","err","initbookitbutton"],"mappings":";;;;;;AAeA,IAAAA,0EAsBOC,eAAoBC,yBAGvBC,QAAQC,IAAI,qBAEOC,SAASC,iBAAiBC,SAASC,eAE3CC,SAAQR,kBACf,MAAMS,GAAKC,UAAUC,QAAQF,GAEvBG,eAAiBF,UAAUG,QAAQP,SAASQ,WAAWC,cAAcT,SAASU,gBAC9EC,YAAc,IAAIC,aAAAA,QAAYR,UAAW,8DAGzCO,YAAYE,KAAK,CAACV,GAAIA,KAE5B,MAAMW,aAAeV,UAAUG,QAAQP,SAASQ,WAAWC,cAAcT,SAASe,cAAgBZ,IAGlGP,QAAQC,IAAIiB,aAAcR,gBAE1BK,YAAYK,iBAAiBL,YAAYM,OAAOC,gBAAgBC,IAC3CA,EAAEC,UAuH/B,SAAwBjB,GAAIC,WAIxB,MAAMU,aAAeV,UAAUG,QAAQP,SAASQ,WAAWC,cAAcT,SAASe,cAAgBZ,IAE9FW,eACAA,aAAaT,QAAQgB,QAAU,QAEvC,CA5HgBC,CAAenB,GAAIC,WAEnBO,YAAYE,KAAK,CAACV,GAAIA,KAC1B,IAGJL,SAASkB,iBAAiBO,QAAAA,WAAWC,sBAAsBL,IAEvDvB,QAAQC,IAAIsB,EAAEM,QAEdC,YAAYvB,GAAIC,UAAWO,YAAahB,wBAAwB,IAGpEgB,YAAYK,iBAAiBL,YAAYM,OAAOU,yBAAyB,KAGrE/B,QAAQC,IAAI,mBAEZ6B,YAAYvB,GAAIC,UAAWO,YAAahB,wBAAwB,IAGpEgB,YAAYK,iBAAiB,UAAUG,IAEnC,GAAIA,EAAEM,OAAOG,UAAUC,SAAS,iBAAkB,CAC9C,MAAMC,OAAShC,SAASW,cAAc,0DACtCE,YAAYoB,sBAAsBD,OACtC,KAGJJ,YAAYvB,GAAIC,UAAWO,YAAahB,wBAAwB,GAExE,EAzEAqC,cANAvC,IAMAuC,eANAvC,IAAAwC,WAAAxC,IAAAyC,CAAAA,QAAAzC,KAMgD,IAAA0C,yCAAA,oBAAAC,OAAAA,OAAA,oBAAAC,KAAAA,KAAA,oBAAAC,OAAAA,OAAA,CAAA,EAIhD,MAAMtC,SAAW,CACbC,cAAe,oCACfO,UAAW,gBACX+B,kBAAmB,kDACnB7B,eAAgB,+CAChBK,cAAe,uDAwEnB,SAASW,YAAYvB,GAAIC,UAAWO,YAAahB,yBAI7C,MAAM6C,aAAepC,UAAUG,QAAQP,SAASQ,WAEhD,IAAKgC,aACD,OAGJ,MAAM1B,aAAe0B,aAAa/B,cAAcT,SAASe,cAAgBZ,IAKrEW,eAGAlB,QAAQC,IAAI,eAAgBiB,cAgCpC,SAAqBgB,OAAQnB,aAGzBf,QAAQC,IAAI,cAAeiC,QAEtBA,OAAOzB,QAAQgB,UAChBS,OAAOzB,QAAQgB,SAAU,EAGzBzB,QAAQC,IAAI,2BAA4BiC,QAExCA,OAAOd,iBAAiB,SAAS,KAG7BpB,QAAQC,IAAI,SAEZc,YAAY8B,gBAAgB,IAGxC,CAjDQC,CAAY5B,aAAcH,cAI9B,IAEQhB,0BACA,mBAAAwC,yCAAAQ,QAAAR,yCAAAQ,OAAAC,IAAAC,IAAAA,SAAAC,SAAAA,QAAAC,QAAAZ,yCAAAa,QAAAF,CAAAA,4BAAAA,QAAAC,OAAA,IAAAE,oBAAAA,QAAAA,OAAAC,SAAAD,oBAAAD,SAAAC,oBAAAA,QAAAA,OAAAE,WAAAhB,yCAAAa,SAAAH,cAAAV,yCAAAa,QAAAI,OAAAP,QAAAC,QAAAE,QAAO,6BAA0BH,QAAAC,QAAAX,uEAExBkB,MAAKC,eACFA,aAAaC,YAAY,IAE5BC,OAAMC,MAGH7D,QAAQC,IAAI4D,IAAI,KAGhC,EAAAC,QAAAA,mBACH,CAAC,MAAOvC,GAELvB,QAAQC,IAAIsB,EAChB,CACJ,CA0CC"}