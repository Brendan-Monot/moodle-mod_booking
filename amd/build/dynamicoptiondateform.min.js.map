{"version":3,"sources":["../src/dynamicoptiondateform.js"],"names":["optiondateForm","DynamicForm","document","querySelector","initdynamicoptiondateform","cmid","bookingid","optionid","modalTitle","formClass","load","then","datelistinit","initmodaloptiondateform","catch","ex","displayException","addEventListener","events","SERVER_VALIDATION_ERROR","FORM_SUBMITTED","e","chooseperiodvalue","value","reoccurringdatestringvalue","preventDefault","response","detail","Templates","renderForPromise","html","innerHTML","appendNodeContents","oldlists","getElementsByClassName","length","parentNode","removeChild","dateform","datelist","insertBefore","nextSibling","action","target","dataset","targetid","closest","remove","getElementById","targetElement","date","element","insertAdjacentHTML","waitForElm","stringelm","submitbutton","trim","toLowerCase","includes","style","display","reoccurringdatestring","customdatesbtn","modalform","ModalForm","modalConfig","title","returnFocus","currentTarget","show","selector","Promise","resolve","observer","MutationObserver","disconnect","observe","body","childList","subtree"],"mappings":"mRAuBA,OACA,OACA,O,sDAEMA,CAAAA,CAAc,CAAG,GAAIC,UAAJ,CAAgBC,QAAQ,CAACC,aAAT,CAAuB,mBAAvB,CAAhB,CAA6D,0CAA7D,C,6BAEkB,QAA5BC,CAAAA,yBAA4B,CAACC,CAAD,CAAOC,CAAP,CAAkBC,CAAlB,CAA4BC,CAA5B,CAAwCC,CAAxC,CAAsD,CAE3FT,CAAc,CAACU,IAAf,CAAoB,CAChB,KAAQL,CADQ,CAEhB,UAAaC,CAFG,CAGhB,SAAYC,CAHI,CAIhB,WAAcC,CAJE,CAKhB,UAAaC,CALG,CAApB,EAOCE,IAPD,CAOM,UAAM,CACRC,CAAY,GACZC,CAAuB,CAACL,CAAD,CAAaC,CAAb,CAE1B,CAXD,EAcCK,KAdD,CAcO,SAAAC,CAAE,QAAIC,CAAAA,gBAAgB,CAACD,CAAD,CAApB,CAdT,EAgBAf,CAAc,CAACiB,gBAAf,CAAgCjB,CAAc,CAACkB,MAAf,CAAsBC,uBAAtD,CAA+E,UAAM,CACjFP,CAAY,GACZC,CAAuB,CAACL,CAAD,CAAaC,CAAb,CAE1B,CAJD,EAMAT,CAAc,CAACiB,gBAAf,CAAgCjB,CAAc,CAACkB,MAAf,CAAsBE,cAAtD,CAAsE,SAACC,CAAD,CAAO,IAGrEC,CAAAA,CAAiB,CAAGpB,QAAQ,CAACC,aAAT,CAAuB,yBAAvB,EAAgDoB,KAHC,CAIrEC,CAA0B,CAAGtB,QAAQ,CAACC,aAAT,CAAuB,kCAAvB,EAAyDoB,KAJjB,CASzEvB,CAAc,CAACU,IAAf,CAAoB,CAChB,KAAQL,CADQ,CAEhB,UAAaC,CAFG,CAGhB,SAAYC,CAHI,CAIhB,WAAcC,CAJE,CAKhB,UAAaC,CALG,CAApB,EAOCE,IAPD,CAOM,UAAM,CAIRU,CAAC,CAACI,cAAF,GACA,GAAMC,CAAAA,CAAQ,CAAGL,CAAC,CAACM,MAAnB,CAEAC,UAAUC,gBAAV,CAA2B,iCAA3B,CAA8DH,CAA9D,EAECf,IAFD,CAEM,WAAY,IAAVmB,CAAAA,CAAU,GAAVA,IAAU,CACd5B,QAAQ,CAACC,aAAT,CAAuB,mBAAvB,EAA4C4B,SAA5C,CAAwD,EAAxD,CACAH,UAAUI,kBAAV,CAA6B,mBAA7B,CAAkDF,CAAlD,CAEH,CAND,EASChB,KATD,CASO,SAAAC,CAAE,QAAIC,CAAAA,gBAAgB,CAACD,CAAD,CAApB,CATT,EAWA,GAAIkB,CAAAA,CAAQ,CAAG/B,QAAQ,CAACgC,sBAAT,CAAgC,kBAAhC,CAAf,CACA,MAAyB,CAAlB,CAAAD,CAAQ,CAACE,MAAhB,CAA4B,CACxBF,CAAQ,CAACA,CAAQ,CAACE,MAAT,CAAkB,CAAnB,CAAR,CAA8BC,UAA9B,CAAyCC,WAAzC,CAAqDJ,CAAQ,CAACA,CAAQ,CAACE,MAAT,CAAkB,CAAnB,CAA7D,CACH,CAGDvB,CAAY,GAGZV,QAAQ,CAACC,aAAT,CAAuB,yBAAvB,EAAgDoB,KAAhD,CAAwDD,CAAxD,CACApB,QAAQ,CAACC,aAAT,CAAuB,kCAAvB,EAAyDoB,KAAzD,CAAiEC,CAAjE,CAEAtB,QAAQ,CAACC,aAAT,CAAuB,aAAvB,EAAsCoB,KAAtC,CAA8CD,CAA9C,CACApB,QAAQ,CAACC,aAAT,CAAuB,gBAAvB,EAAyCoB,KAAzC,CAAiDC,CAAjD,CAGAX,CAAuB,CAACL,CAAD,CAAaC,CAAb,CAG1B,CA5CD,EA+CCK,KA/CD,CA+CO,SAAAC,CAAE,QAAIC,CAAAA,gBAAgB,CAACD,CAAD,CAApB,CA/CT,CAgDH,CAzDD,CA0DH,C,CAEM,GAAMH,CAAAA,CAAY,CAAG,UAAM,IAE1B0B,CAAAA,CAAQ,CAAGpC,QAAQ,CAACC,aAAT,CAAuB,mBAAvB,CAFe,CAG1BoC,CAAQ,CAAGrC,QAAQ,CAACC,aAAT,CAAuB,mBAAvB,CAHe,CAK9BoC,CAAQ,CAACH,UAAT,CAAoBC,WAApB,CAAgCE,CAAhC,EAEAD,CAAQ,CAACF,UAAT,CAAoBI,YAApB,CAAiCD,CAAjC,CAA2CD,CAAQ,CAACG,WAApD,EAEAF,CAAQ,CAACtB,gBAAT,CAA0B,OAA1B,CAAmC,SAASI,CAAT,CAAY,IAEvCqB,CAAAA,CAAM,CAAGrB,CAAC,CAACsB,MAAF,CAASC,OAAT,CAAiBF,MAFa,CAGvCG,CAAQ,CAAGxB,CAAC,CAACsB,MAAF,CAASC,OAAT,CAAiBC,QAHW,CAK3C,GAAe,QAAX,GAAAH,CAAJ,CAAyB,CACrBrB,CAAC,CAACsB,MAAF,CAASG,OAAT,CAAiB,IAAjB,EAAuBC,MAAvB,GACA7C,QAAQ,CAAC8C,cAAT,CAAwBH,CAAxB,EAAkCE,MAAlC,EACH,CAED,GAAe,KAAX,GAAAL,CAAJ,CAAsB,IACdO,CAAAA,CAAa,CAAG5B,CAAC,CAACsB,MAAF,CAASG,OAAT,CAAiB,IAAjB,CADF,CAEdI,CAAI,CAAGhD,QAAQ,CAACC,aAAT,CAAuB,eAAvB,CAFO,CAGdgD,CAAO,CAAG,wCAAwCD,CAAI,CAAC3B,KAA7C,CACV,iFAJc,CAKlB0B,CAAa,CAACG,kBAAd,CAAiC,UAAjC,CAA6CD,CAA7C,CACH,CACJ,CAjBD,EAqBAjD,QAAQ,CAACC,aAAT,CAAuB,yBAAvB,EAAgDc,gBAAhD,CAAiE,QAAjE,CAA2E,SAACI,CAAD,CAAO,CAC9EnB,QAAQ,CAACC,aAAT,CAAuB,aAAvB,EAAsCoB,KAAtC,CAA8CF,CAAC,CAACsB,MAAF,CAASpB,KAC1D,CAFD,EAIA8B,CAAU,CAAC,uCAAD,CAAV,CAAkD1C,IAAlD,CAAuD,SAAC2C,CAAD,CAAe,CAClE,GAAMC,CAAAA,CAAY,CAAGrD,QAAQ,CAACC,aAAT,CAAuB,gDAAvB,CAArB,CACA,GAAImD,CAAS,CAAC/B,KAAV,CAAgBiC,IAAhB,GAAuBC,WAAvB,GAAqCC,QAArC,CAA8C,OAA9C,CAAJ,CAA4D,CACxDH,CAAY,CAACI,KAAb,CAAmBC,OAAnB,CAA6B,MAChC,CAFD,IAEO,CACHL,CAAY,CAACI,KAAb,CAAmBC,OAAnB,CAA6B,OAChC,CACJ,CAPD,EAWA,GAAMC,CAAAA,CAAqB,CAAG3D,QAAQ,CAACC,aAAT,CAAuB,uCAAvB,CAA9B,CACA0D,CAAqB,CAAC5C,gBAAtB,CAAuC,OAAvC,CAAgD,SAACI,CAAD,CAAO,CACnD,GAAMkC,CAAAA,CAAY,CAAGrD,QAAQ,CAACC,aAAT,CAAuB,gDAAvB,CAArB,CACA,GAAIkB,CAAC,CAACsB,MAAF,CAASpB,KAAT,CAAeiC,IAAf,GAAsBC,WAAtB,GAAoCC,QAApC,CAA6C,OAA7C,CAAJ,CAA2D,CACvDH,CAAY,CAACI,KAAb,CAAmBC,OAAnB,CAA6B,MAChC,CAFD,IAEO,CACHL,CAAY,CAACI,KAAb,CAAmBC,OAAnB,CAA6B,OAChC,CACD1D,QAAQ,CAACC,aAAT,CAAuB,gBAAvB,EAAyCoB,KAAzC,CAAiDF,CAAC,CAACsB,MAAF,CAASpB,KAC7D,CARD,CASH,CAvDM,C,iBAyDA,GAAMV,CAAAA,CAAuB,CAAG,SAACL,CAAD,CAAaC,CAAb,CAA2B,CAC9D4C,CAAU,CAAC,iCAAD,CAAV,CAA4C1C,IAA5C,CAAiD,SAACmD,CAAD,CAAoB,CACjEA,CAAc,CAAC7C,gBAAf,CAAgC,OAAhC,CAAyC,SAACI,CAAD,CAAO,CAC5CA,CAAC,CAACI,cAAF,GACA,GAAMsC,CAAAA,CAAS,CAAG,GAAIC,UAAJ,CAAc,CAC5BvD,SAAS,CAATA,CAD4B,CAE5BwD,WAAW,CAAE,CAACC,KAAK,CAAE1D,CAAR,CAFe,CAG5B2D,WAAW,CAAE9C,CAAC,CAAC+C,aAHa,CAAd,CAAlB,CAMAL,CAAS,CAAC9C,gBAAV,CAA2B8C,CAAS,CAAC7C,MAAV,CAAiBE,cAA5C,CAA4D,SAACC,CAAD,CAAO,CAC/D,GAAMK,CAAAA,CAAQ,CAAGL,CAAC,CAACM,MAAnB,CAEAC,UAAUC,gBAAV,CAA2B,mDAA3B,CAAgFH,CAAhF,EAECf,IAFD,CAEM,WAAY,IAAVmB,CAAAA,CAAU,GAAVA,IAAU,CACdF,UAAUI,kBAAV,CAA6B,qBAA7B,CAAoDF,CAApD,CAEH,CALD,EAQChB,KARD,CAQO,SAAAC,CAAE,QAAIC,CAAAA,gBAAgB,CAACD,CAAD,CAApB,CART,EAUAa,UAAUC,gBAAV,CAA2B,sDAA3B,CAAmFH,CAAnF,EAECf,IAFD,CAEM,WAAY,IAAVmB,CAAAA,CAAU,GAAVA,IAAU,CACdF,UAAUI,kBAAV,CAA6B,sBAA7B,CAAqDF,CAArD,CAEH,CALD,EAQChB,KARD,CAQO,SAAAC,CAAE,QAAIC,CAAAA,gBAAgB,CAACD,CAAD,CAApB,CART,CASH,CAtBD,EAwBAgD,CAAS,CAACM,IAAV,EACH,CAjCD,CAkCH,CAnCD,CAoCH,CArCM,C,4BA4CN,QAAShB,CAAAA,CAAT,CAAoBiB,CAApB,CAA8B,CAE3B,MAAO,IAAIC,CAAAA,OAAJ,CAAY,SAAAC,CAAO,CAAI,CAC1B,GAAItE,QAAQ,CAACC,aAAT,CAAuBmE,CAAvB,CAAJ,CAAsC,CAClC,MAAOE,CAAAA,CAAO,CAACtE,QAAQ,CAACC,aAAT,CAAuBmE,CAAvB,CAAD,CACjB,CACD,GAAMG,CAAAA,CAAQ,CAAG,GAAIC,CAAAA,gBAAJ,CAAqB,UAAM,CACxC,GAAIxE,QAAQ,CAACC,aAAT,CAAuBmE,CAAvB,CAAJ,CAAsC,CAClCE,CAAO,CAACtE,QAAQ,CAACC,aAAT,CAAuBmE,CAAvB,CAAD,CAAP,CACAG,CAAQ,CAACE,UAAT,EACH,CACJ,CALgB,CAAjB,CAMAF,CAAQ,CAACG,OAAT,CAAiB1E,QAAQ,CAAC2E,IAA1B,CAAgC,CAC5BC,SAAS,GADmB,CAE5BC,OAAO,GAFqB,CAAhC,CAIH,CAdM,CAeV,C","sourcesContent":["/* eslint-disable promise/always-return */\n/* eslint-disable promise/catch-or-return */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * @package    mod_booking\n * @copyright  2022 Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport DynamicForm from 'core_form/dynamicform';\nimport ModalForm from 'core_form/modalform';\nimport Templates from 'core/templates';\n\nconst optiondateForm = new DynamicForm(document.querySelector('#optiondates-form'), 'mod_booking\\\\form\\\\dynamicoptiondateform');\n\nexport const initdynamicoptiondateform = (cmid, bookingid, optionid, modalTitle, formClass) => {\n\n    optiondateForm.load({\n        'cmid': cmid,\n        'bookingid': bookingid,\n        'optionid': optionid,\n        'modalTitle': modalTitle,\n        'formClass': formClass\n    })\n    .then(() => {\n        datelistinit();\n        initmodaloptiondateform(modalTitle, formClass);\n        return;\n    })\n    // Deal with this exception (Using core/notify exception function is recommended).\n    // eslint-disable-next-line no-undef\n    .catch(ex => displayException(ex));\n\n    optiondateForm.addEventListener(optiondateForm.events.SERVER_VALIDATION_ERROR, () => {\n        datelistinit();\n        initmodaloptiondateform(modalTitle, formClass);\n        return;\n    });\n\n    optiondateForm.addEventListener(optiondateForm.events.FORM_SUBMITTED, (e) => {\n\n        // Remember values when form gets submitted.\n        var chooseperiodvalue = document.querySelector('[name=\"chooseperiod\"]').value;\n        var reoccurringdatestringvalue = document.querySelector('[name=\"reoccurringdatestring\"]').value;\n\n        // It is recommended to reload the form after submission because the elements may change.\n        // This will also remove previous submission errors. You will need to pass the same arguments to the form\n        // that you passed when you rendered the form on the page.\n        optiondateForm.load({\n            'cmid': cmid,\n            'bookingid': bookingid,\n            'optionid': optionid,\n            'modalTitle': modalTitle,\n            'formClass': formClass\n        })\n        .then(() => {\n            // Only do this, if it's not a blocked event.\n            /* if (!reoccurringdatestringvalue.trim().toLowerCase().includes('block')) {} */\n\n            e.preventDefault();\n            const response = e.detail;\n\n            Templates.renderForPromise('mod_booking/bookingoption_dates', response)\n            // It returns a promise that needs to be resolved.\n            .then(({html}) => {\n                document.querySelector('.optiondates-list').innerHTML = '';\n                Templates.appendNodeContents('.optiondates-list', html);\n                return;\n            })\n            // Deal with this exception (Using core/notify exception function is recommended).\n            // eslint-disable-next-line no-undef\n            .catch(ex => displayException(ex));\n\n            var oldlists = document.getElementsByClassName('optiondates-list');\n            while (oldlists.length > 1) {\n                oldlists[oldlists.length - 1].parentNode.removeChild(oldlists[oldlists.length - 1]);\n            }\n\n            // This is needed to fix datelist bugs.\n            datelistinit();\n\n            // We need this, so we don't lose the form data after reloading.\n            document.querySelector('[name=\"chooseperiod\"]').value = chooseperiodvalue;\n            document.querySelector('[name=\"reoccurringdatestring\"]').value = reoccurringdatestringvalue;\n            // Also load the data into the hidden elements which we need to pass the values to the non-dynamic form.\n            document.querySelector('#semesterid').value = chooseperiodvalue;\n            document.querySelector('#dayofweektime').value = reoccurringdatestringvalue;\n\n            // Initialize modal again.\n            initmodaloptiondateform(modalTitle, formClass);\n\n            return;\n        })\n        // Deal with this exception (Using core/notify exception function is recommended).\n        // eslint-disable-next-line no-undef\n        .catch(ex => displayException(ex));\n    });\n};\n\nexport const datelistinit = () => {\n\n    var dateform = document.querySelector(\"#optiondates-form\");\n    var datelist = document.querySelector(\".optiondates-list\");\n\n    datelist.parentNode.removeChild(datelist);\n    // Important: Move datelist after dateform so $_POST will work in PHP.\n    dateform.parentNode.insertBefore(datelist, dateform.nextSibling);\n\n    datelist.addEventListener('click', function(e) {\n\n        let action = e.target.dataset.action;\n        let targetid = e.target.dataset.targetid;\n\n        if (action === 'delete') {\n            e.target.closest('li').remove();\n            document.getElementById(targetid).remove();\n        }\n\n        if (action === 'add') {\n            let targetElement = e.target.closest('li');\n            let date = document.querySelector(\"#meeting-time\");\n            let element = '<li><span class=\"badge bg-primary\">' + date.value +\n                '</span> <i class=\"fa fa-trash ml-2 icon-red\" data-action=\"delete\"></i></li>';\n            targetElement.insertAdjacentHTML('afterend', element);\n        }\n    });\n\n    // Add an event listener to the chooseperiod autocomplete to store semesterid in a hidden input field.\n    // We need this, so we can save it later via $_POST from the not dynamic moodle form.\n    document.querySelector('[name=\"chooseperiod\"]').addEventListener('change', (e) => {\n        document.querySelector('#semesterid').value = e.target.value;\n    });\n\n    waitForElm('input[name=\"reoccurringdatestring\"]').then((stringelm) => {\n        const submitbutton = document.querySelector('#optiondates-form input[name=\"submitbutton\"]');\n        if (stringelm.value.trim().toLowerCase().includes('block')) {\n            submitbutton.style.display = 'none'; // Hide the button.\n        } else {\n            submitbutton.style.display = 'block'; // Show the button.\n        }\n    });\n\n    // Add an event listener to the reoccurring datestring to store it in a hidden input field.\n    // We need this, so we can save it later via $_POST from the not dynamic moodle form.\n    const reoccurringdatestring = document.querySelector('input[name=\"reoccurringdatestring\"]');\n    reoccurringdatestring.addEventListener('keyup', (e) => {\n        const submitbutton = document.querySelector('#optiondates-form input[name=\"submitbutton\"]');\n        if (e.target.value.trim().toLowerCase().includes('block')) {\n            submitbutton.style.display = 'none'; // Hide the button.\n        } else {\n            submitbutton.style.display = 'block'; // Show the button.\n        }\n        document.querySelector('#dayofweektime').value = e.target.value;\n    });\n};\n\nexport const initmodaloptiondateform = (modalTitle, formClass) => {\n    waitForElm('button[name=\"customdatesbtn\"]').then((customdatesbtn) => {\n        customdatesbtn.addEventListener('click', (e) => {\n            e.preventDefault();\n            const modalform = new ModalForm({\n                formClass,\n                modalConfig: {title: modalTitle},\n                returnFocus: e.currentTarget\n            });\n            // If necessary extend functionality by overriding class methods, for example:\n            modalform.addEventListener(modalform.events.FORM_SUBMITTED, (e) => {\n                const response = e.detail;\n\n                Templates.renderForPromise('mod_booking/bookingoption_dates_custom_list_items', response)\n                // It returns a promise that needs to be resolved.\n                .then(({html}) => {\n                    Templates.appendNodeContents('ul.reoccurringdates', html);\n                    return;\n                })\n                // Deal with this exception (Using core/notify exception function is recommended).\n                // eslint-disable-next-line no-undef\n                .catch(ex => displayException(ex));\n\n                Templates.renderForPromise('mod_booking/bookingoption_dates_custom_hidden_inputs', response)\n                // It returns a promise that needs to be resolved.\n                .then(({html}) => {\n                    Templates.appendNodeContents('div.optiondates-list', html);\n                    return;\n                })\n                // Deal with this exception (Using core/notify exception function is recommended).\n                // eslint-disable-next-line no-undef\n                .catch(ex => displayException(ex));\n            });\n            // Show the modal.\n            modalform.show();\n        });\n    });\n};\n\n/**\n * Wait until a certain element is loaded.\n * @param {string} selector - The element selector.\n * @returns {Promise}\n */\n function waitForElm(selector) {\n    // eslint-disable-next-line consistent-return\n    return new Promise(resolve => {\n        if (document.querySelector(selector)) {\n            return resolve(document.querySelector(selector));\n        }\n        const observer = new MutationObserver(() => {\n            if (document.querySelector(selector)) {\n                resolve(document.querySelector(selector));\n                observer.disconnect();\n            }\n        });\n        observer.observe(document.body, {\n            childList: true,\n            subtree: true\n        });\n    });\n}\n"],"file":"dynamicoptiondateform.min.js"}