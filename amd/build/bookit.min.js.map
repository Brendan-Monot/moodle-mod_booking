{"version":3,"file":"bookit.min.js","sources":["../src/bookit.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/bookit\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\nvar currentbookitpage = {};\nvar totalbookitpages = {};\n\nvar SELECTORS = {\n    MODALID: 'sbPrePageModal_',\n    INMODALDIV: ' div.pageContent',\n    CONTINUEBUTTON: 'a.continue-button', // Don't want to find button right now.\n    BACKBUTTON: 'a.back-button', // Don't want to find button right now.\n    BOOKITBUTTON: 'div.booking-button-area',\n    INMODALBUTTON: 'div.in-modal-button',\n    STATICBACKDROP: 'div.modal-backdrop',\n};\n\n/**\n * Initializes the bookit button for the normal bookit function.\n * @param {integer} itemid\n * @param {string} area\n */\nexport const initbookitbutton = (itemid, area) => {\n\n    const initselector = SELECTORS.BOOKITBUTTON +\n    '[data-itemid]' +\n    '[data-area]';\n\n    if (!itemid || !area) {\n        const initbuttons = document.querySelectorAll(initselector);\n        initbuttons.forEach(button => {\n            const inititemid = button.dataset.itemid;\n            const initarea = button.dataset.area;\n            initbookitbutton(inititemid, initarea);\n        });\n        return;\n    }\n\n    const selector = SELECTORS.BOOKITBUTTON +\n    '[data-itemid=\"' + itemid + '\"]' +\n    '[data-area=\"' + area + '\"]';\n\n    const buttons = document.querySelectorAll(selector);\n\n    if (!buttons) {\n        return;\n    }\n\n    // We support more than one booking button on the same page.\n    buttons.forEach(button => {\n\n        if (button.dataset.nojs) {\n            return;\n        }\n\n        if (!button.dataset.initialized) {\n            button.dataset.initialized = 'true';\n\n            const userid = button.dataset.userid;\n\n            button.addEventListener('click', e => {\n\n                e.stopPropagation();\n\n                bookit(itemid, area, userid);\n            });\n        }\n    });\n};\n\n/**\n * Gets called from mustache template.\n * @param {integer} optionid\n * @param {integer} totalnumberofpages\n * @param {string} uniquid\n */\nexport const initprepagemodal = (optionid, totalnumberofpages, uniquid) => {\n\n    // eslint-disable-next-line no-console\n    console.log('initprepagemodal', optionid, totalnumberofpages, uniquid);\n\n    currentbookitpage[optionid] = 0;\n    totalbookitpages[optionid] = totalnumberofpages;\n\n    respondToVisibility(optionid, totalnumberofpages, uniquid, loadPreBookingPage);\n};\n\n/**\n * React on visibility change.\n * @param {integer} optionid\n * @param {integer} totalnumberofpages\n * @param {string} uniquid\n * @param {function} callback\n */\nfunction respondToVisibility(optionid, totalnumberofpages, uniquid, callback) {\n\n    // eslint-disable-next-line no-console\n    console.log('respondToVisibility', optionid, totalnumberofpages, uniquid);\n\n    if (totalnumberofpages < 1) {\n        return;\n    }\n\n    let elements = document.querySelectorAll(\"[id^=\" + SELECTORS.MODALID + optionid + \"_\" + uniquid + \"]\");\n\n    elements.forEach(element => {\n        if (!element) {\n            return;\n        }\n\n        var observer = new MutationObserver(function() {\n            if (!isHidden(element)) {\n                // Todo: Make sure it's not triggered on close.\n                callback(optionid, uniquid, totalnumberofpages);\n            }\n        });\n\n        // We look if we find a hidden parent. If not, we load right away.\n        while (element !== null) {\n            if (!isHidden(element)) {\n                element = element.parentElement;\n            } else {\n                if (element.dataset.observed) {\n                    return;\n                }\n\n                observer.observe(element, {attributes: true});\n                element.dataset.observed = true;\n                return;\n            }\n        }\n        callback(optionid, totalnumberofpages);\n    });\n}\n\n/**\n * Function to check visibility of element.\n * @param {*} el\n * @returns {boolean}\n */\nfunction isHidden(el) {\n    var style = window.getComputedStyle(el);\n    return ((style.display === 'none') || (style.visibility === 'hidden'));\n}\n\n/**\n * Loads the (next) pre booking page.\n * @param {integer} optionid\n * @param {string} uniquid\n */\nexport const loadPreBookingPage = (\n    optionid, uniquid) => {\n\n    // eslint-disable-next-line no-console\n    console.log('loadPreBookingPage', optionid, uniquid);\n\n    const element = returnVisibleElement(optionid, uniquid, SELECTORS.INMODALDIV);\n    if (element) {\n        while (element.firstChild) {\n            element.removeChild(element.firstChild);\n        }\n    } else {\n        // eslint-disable-next-line no-console\n        console.error('didnt find element');\n    }\n\n    Ajax.call([{\n        methodname: \"mod_booking_load_pre_booking_page\",\n        args: {\n            'optionid': optionid,\n            'pagenumber': currentbookitpage[optionid],\n        },\n        done: function(res) {\n\n            // eslint-disable-next-line no-console\n            console.log(currentbookitpage[optionid], totalbookitpages[optionid]);\n\n            // If we are on the last page, we reset it to 0.\n            if (currentbookitpage[optionid] === totalbookitpages[optionid] - 1) {\n                currentbookitpage[optionid] = 0;\n            }\n\n            const jsonobject = JSON.parse(res.json);\n\n            // We support more than one template, they will be seperated by comma.\n            // We have a data key in the json\n            const templates = res.template.split(',');\n            let dataarray = jsonobject;\n            // const buttontype = res.buttontype;\n\n            renderTemplatesOnPage(templates, dataarray, element);\n\n            // showRightButton(optionid, buttontype);\n\n            return true;\n        },\n        fail: function(err) {\n            // eslint-disable-next-line no-console\n            console.log(err);\n        }\n    }]);\n};\n\n/**\n *\n * @param {string} templates\n * @param {object} dataarray\n * @param {HTMLElement} element\n */\nasync function renderTemplatesOnPage(templates, dataarray, element) {\n\n    for (const template of templates) {\n\n        const data = dataarray.shift();\n\n        if (!data) {\n            return true;\n        }\n\n        await Templates.renderForPromise(template, data.data).then(({html, js}) => {\n\n            Templates.appendNodeContents(element, html, js);\n\n            return true;\n        }).catch(ex => {\n            Notification.addNotification({\n                message: 'failed rendering ' + ex,\n                type: \"danger\"\n            });\n        });\n    }\n    return true;\n}\n\n/**\n *\n * @param {int} itemid\n * @param {string} area\n * @param {int} userid\n */\nfunction bookit(itemid, area, userid) {\n\n    Ajax.call([{\n        methodname: \"mod_booking_bookit\",\n        args: {\n            'itemid': itemid,\n            'area': area,\n            'userid': userid,\n        },\n        done: function(res) {\n\n            const jsonarray = JSON.parse(res.json);\n\n            // We might have more than one template to render.\n            const templates = res.template.split(',');\n\n            // There might be more than one button area.\n            const buttons = document.querySelectorAll(SELECTORS.BOOKITBUTTON +\n                '[data-itemid=\\'' + itemid + '\\']' +\n                '[data-area=\\'' + area + '\\']');\n\n            const promises = [];\n\n            // We run through every button. and render the data.\n            buttons.forEach(button => {\n\n                while (button.firstChild) {\n                    const child = button.firstChild;\n                    child.remove();\n                }\n\n                // For every button, we need a new jsonarray.\n                const arraytoreduce = [...jsonarray];\n\n                templates.forEach(template => {\n                    const data = arraytoreduce.shift();\n\n                    // We need to check if this will render the prepagemodal again.\n                    // We never render the prepage modal in the in modal button.\n                    if (!(template === 'mod_booking/bookingpage/prepagemodal'\n                            && button.parentElement.classList.contains('in-modal-button'))) {\n\n                        const datatorender = data.data ?? data;\n\n                        const promise = Templates.renderForPromise(template, datatorender).then(({html, js}) => {\n\n                            Templates.appendNodeContents(button, html, js);\n\n                            return true;\n                        }).catch(ex => {\n                            Notification.addNotification({\n                                message: 'failed rendering ' + ex,\n                                type: \"danger\"\n                            });\n                        });\n\n                        promises.push(promise);\n                    }\n                });\n            });\n\n            Promise.all(promises).then(() => {\n\n                // The actions on successful booking are executed elsewhere.\n                return true;\n            }).catch(e => {\n                // eslint-disable-next-line no-console\n                console.log(e);\n            });\n        }\n    }]);\n}\n\n/**\n * We want to find out the visible modal\n * @param {integer} optionid\n * @param {string} uniquid\n * @param {string} appendedSelector\n * @returns {HTMLElement}\n */\nfunction returnVisibleElement(optionid, uniquid, appendedSelector) {\n\n    // First, we get all the possbile Elements (we don't now the unique id appended to the element.)\n    let selector = \"[id^=\" + SELECTORS.MODALID + optionid + \"_\" + uniquid + \"] \" + appendedSelector;\n    if (!uniquid || uniquid.length === 0) {\n        selector = \"[id^=\" + SELECTORS.MODALID + optionid + \"].show \" + appendedSelector;\n    }\n\n    const elements = document.querySelectorAll(selector);\n\n    let visibleElement = null;\n\n    elements.forEach(element => {\n\n        // eslint-disable-next-line no-console\n        console.log('visibleElement', selector, element);\n\n        visibleElement = element;\n    });\n\n    return visibleElement;\n}\n\n/**\n * Load next prepage booking page.\n * @param {int} optionid\n */\nexport function continueToNextPage(optionid) {\n\n    currentbookitpage[optionid]++;\n\n    loadPreBookingPage(optionid);\n}\n\n/**\n *  Load previous prepage booking page.\n * @param {int} optionid\n */\nexport function backToPreviousPage(optionid) {\n\n    currentbookitpage[optionid]--;\n\n    loadPreBookingPage(optionid);\n}"],"names":["optionid","currentbookitpage","loadPreBookingPage","totalbookitpages","SELECTORS","initbookitbutton","itemid","area","initselector","document","querySelectorAll","forEach","button","inititemid","dataset","initarea","selector","buttons","nojs","initialized","userid","addEventListener","e","stopPropagation","call","methodname","args","done","res","jsonarray","JSON","parse","json","templates","template","split","promises","firstChild","remove","arraytoreduce","data","shift","parentElement","classList","contains","datatorender","promise","Templates","renderForPromise","then","_ref2","html","js","appendNodeContents","catch","ex","addNotification","message","type","push","Promise","all","console","log","bookit","isHidden","el","style","window","getComputedStyle","display","visibility","totalnumberofpages","uniquid","callback","element","observer","MutationObserver","observed","observe","attributes","respondToVisibility","appendedSelector","length","elements","visibleElement","returnVisibleElement","removeChild","error","jsonobject","dataarray","_ref","renderTemplatesOnPage","fail","err"],"mappings":"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"}