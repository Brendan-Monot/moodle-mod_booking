define("mod_booking/bookit",["exports","core/ajax","core/templates","core/notification","local_wunderbyte_table/reload"],(function(_exports,_ajax,_templates,_notification,_reload){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * @module     mod_booking/bookit
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.backToPreviousPage=function(optionid){currentbookitpage[optionid]--,loadPreBookingPage(optionid)},_exports.continueToNextPage=function(optionid){currentbookitpage[optionid]++,loadPreBookingPage(optionid)},_exports.loadPreBookingPage=_exports.initprepagemodal=_exports.initbookitbutton=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var currentbookitpage={},totalbookitpages={},SELECTORS_MODALID="sbPrePageModal_",SELECTORS_INMODALDIV=" div.pageContent",SELECTORS_BOOKITBUTTON="div.booking-button-area.noprice";const initbookitbutton=(itemid,area)=>{const initselector=SELECTORS_BOOKITBUTTON+"[data-itemid][data-area]";if(!itemid||!area){return void document.querySelectorAll(initselector).forEach((button=>{const inititemid=button.dataset.itemid,initarea=button.dataset.area;initbookitbutton(inititemid,initarea)}))}const selector=SELECTORS_BOOKITBUTTON+'[data-itemid="'+itemid+'"][data-area="'+area+'"]',buttons=document.querySelectorAll(selector);buttons&&buttons.forEach((button=>{if(!button.dataset.nojs&&!button.dataset.initialized){button.dataset.initialized="true";const userid=button.dataset.userid;button.addEventListener("click",(e=>{e.stopPropagation(),function(itemid,area,userid){_ajax.default.call([{methodname:"mod_booking_bookit",args:{itemid:itemid,area:area,userid:userid},done:function(res){const jsonarray=JSON.parse(res.json),templates=res.template.split(","),buttons=document.querySelectorAll(SELECTORS_BOOKITBUTTON+"[data-itemid='"+itemid+"'][data-area='"+area+"']"),promises=[];buttons.forEach((button=>{for(;button.firstChild;){button.firstChild.remove()}const arraytoreduce=[...jsonarray];templates.forEach((template=>{const data=arraytoreduce.shift();if("mod_booking/bookingpage/prepagemodal"!==template||!button.parentElement.classList.contains("in-modal-button")){var _data$data;const datatorender=null!==(_data$data=data.data)&&void 0!==_data$data?_data$data:data,promise=_templates.default.renderForPromise(template,datatorender).then((_ref2=>{let{html:html,js:js}=_ref2;return _templates.default.appendNodeContents(button,html,js),!0})).catch((ex=>{_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}));promises.push(promise)}}))})),Promise.all(promises).then((()=>(console.log("we could reload tables now"),(0,_reload.reloadAllTables)(),!0))).catch((e=>{console.log(e)}))}}])}(itemid,area,userid)}))}}))};_exports.initbookitbutton=initbookitbutton;const initprepagemodal=(optionid,totalnumberofpages,uniquid)=>{if(console.log("initprepagemodal",optionid,totalnumberofpages,uniquid),optionid&&uniquid&&totalnumberofpages)currentbookitpage[optionid]=0,totalbookitpages[optionid]=totalnumberofpages,function(optionid,totalnumberofpages,uniquid,callback){console.log("respondToVisibility",optionid,totalnumberofpages,uniquid),document.querySelectorAll("[id^="+SELECTORS_MODALID+optionid+"_"+uniquid+"]").forEach((element=>{if(element&&"true"!=element.dataset.initialized){element.dataset.initialized=!0;for(var observer=new MutationObserver((function(){isHidden(element)||callback(optionid,uniquid,totalnumberofpages)}));null!==element;){if(isHidden(element)){if(element.dataset.observed)return;return observer.observe(element,{attributes:!0}),void(element.dataset.observed=!0)}element=element.parentElement}callback(optionid,totalnumberofpages)}}))}(optionid,totalnumberofpages,uniquid,loadPreBookingPage);else{document.querySelectorAll("[id^="+SELECTORS_MODALID).forEach((element=>{optionid=element.dataset.optionid,uniquid=element.dataset.uniquid,totalnumberofpages=element.dataset.pages,optionid&&uniquid&&initprepagemodal(optionid,totalnumberofpages,uniquid)}))}};function isHidden(el){var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility}_exports.initprepagemodal=initprepagemodal;const loadPreBookingPage=(optionid,uniquid)=>{console.log("loadPreBookingPage",optionid,uniquid);const element=function(optionid,uniquid,appendedSelector){let selector="[id^="+SELECTORS_MODALID+optionid+"_"+uniquid+"] "+appendedSelector;uniquid&&0!==uniquid.length||(selector="[id^="+SELECTORS_MODALID+optionid+"].show "+appendedSelector);const elements=document.querySelectorAll(selector);let visibleElement=null;return elements.forEach((element=>{console.log("visibleElement",selector,element),visibleElement=element})),visibleElement}(optionid,uniquid,SELECTORS_INMODALDIV);if(element)for(;element.firstChild;)element.removeChild(element.firstChild);else console.error("didnt find element");_ajax.default.call([{methodname:"mod_booking_load_pre_booking_page",args:{optionid:optionid,pagenumber:currentbookitpage[optionid]},done:function(res){console.log(currentbookitpage[optionid],totalbookitpages[optionid]),currentbookitpage[optionid]===totalbookitpages[optionid]-1&&(currentbookitpage[optionid]=0);const jsonobject=JSON.parse(res.json);return async function(templates,dataarray,element){for(const template of templates){const data=dataarray.shift();if(!data)return!0;await _templates.default.renderForPromise(template,data.data).then((_ref=>{let{html:html,js:js}=_ref;return _templates.default.appendNodeContents(element,html,js),!0})).catch((ex=>{_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}))}}(res.template.split(","),jsonobject,element),!0},fail:function(err){console.log(err)}}])};_exports.loadPreBookingPage=loadPreBookingPage}));

//# sourceMappingURL=bookit.min.js.map