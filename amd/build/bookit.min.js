define("mod_booking/bookit",["exports","core/ajax","core/templates","core/notification"],(function(_exports,_ajax,_templates,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * @module     mod_booking/bookit
   * @copyright  Wunderbyte GmbH <info@wunderbyte.at>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.loadPreBookingPage=_exports.initprepagemodal=_exports.initbookitbutton=void 0,_exports.toggleContinueButton=toggleContinueButton,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var currentbookitpage={},totalbookitpages={},SELECTORS_MODALID="#sbPrePageModal",SELECTORS_INMODALDIV=" div.pageContent",SELECTORS_CONTINUEBUTTON="a.continue-button",SELECTORS_BACKBUTTON="a.back-button",SELECTORS_BOOKITBUTTON="div.booking-button-area",SELECTORS_INMODALBUTTON="div.in-modal-button",SELECTORS_STATICBACKDROP="div.modal-backdrop";const initbookitbutton=(itemid,area)=>{console.log("initbookitbutton",itemid,area);const initselector=SELECTORS_BOOKITBUTTON+"[data-itemid][data-area]";if(!itemid||!area){return void document.querySelectorAll(initselector).forEach((button=>{const inititemid=button.dataset.itemid,initarea=button.dataset.area;initbookitbutton(inititemid,initarea)}))}const selector=SELECTORS_BOOKITBUTTON+'[data-itemid="'+itemid+'"][data-area="'+area+'"]',buttons=document.querySelectorAll(selector);console.log(selector,buttons),buttons&&buttons.forEach((button=>{if(!button.dataset.nojs&&(console.log("add click listener ",button),!button.dataset.initialized)){button.dataset.initialized="true";const userid=button.dataset.userid;button.addEventListener("click",(e=>{e.stopPropagation(),console.log("clicked ",e.target),function(itemid,area,userid){_ajax.default.call([{methodname:"mod_booking_bookit",args:{itemid:itemid,area:area,userid:userid},done:function(res){console.log(res);const jsonarray=JSON.parse(res.json),templates=res.template.split(","),buttons=document.querySelectorAll(SELECTORS_BOOKITBUTTON+"[data-itemid='"+itemid+"'][data-area='"+area+"']"),promises=[];buttons.forEach((button=>{for(;button.firstChild;){button.firstChild.remove()}const arraytoreduce=[...jsonarray];console.log(templates,arraytoreduce),templates.forEach((template=>{const data=arraytoreduce.shift();if("mod_booking/prepagemodal"!==template||!button.parentElement.classList.contains("in-modal-button")){var _data$data;console.log(template,data,button);const datatorender=null!==(_data$data=data.data)&&void 0!==_data$data?_data$data:data;console.log(datatorender);const promise=_templates.default.renderForPromise(template,datatorender).then((_ref2=>{let{html:html,js:js}=_ref2;return _templates.default.appendNodeContents(button,html,js),!0})).catch((ex=>{_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}));promises.push(promise)}}))})),Promise.all(promises).then((()=>{if(console.log(currentbookitpage[itemid],totalbookitpages[itemid]),currentbookitpage[itemid]==totalbookitpages[itemid]-1){const backdrop=document.querySelector(SELECTORS_STATICBACKDROP),modal=document.querySelector(SELECTORS_MODALID+itemid);modal&&modal.classList.remove("show"),backdrop&&backdrop.remove()}else toggleContinueButton(itemid,!0);return!0})).catch((e=>{console.log(e)}))}}])}(itemid,area,userid)}))}}))};_exports.initbookitbutton=initbookitbutton;function isHidden(el){var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility}_exports.initprepagemodal=(optionid,totalnumberofpages)=>{currentbookitpage[optionid]=0,totalbookitpages[optionid]=totalnumberofpages,function(optionid,totalnumberofpages,callback){if(totalnumberofpages<1)return;const selector=SELECTORS_MODALID+optionid+SELECTORS_INMODALDIV;let element=document.querySelector(selector);if(!element)return;var observer=new MutationObserver((function(){isHidden(element)||callback(optionid)}));for(;null!==element;){if(isHidden(element)){if(element.dataset.observed)return;return observer.observe(element,{attributes:!0}),void(element.dataset.observed=!0)}element=element.parentElement}callback(optionid,totalnumberofpages)}(optionid,totalnumberofpages,loadPreBookingPage),initializeButton(optionid,!0),initializeButton(optionid,!1)};const loadPreBookingPage=optionid=>{const selector=SELECTORS_MODALID+optionid+SELECTORS_INMODALDIV,element=document.querySelector(selector);for(;element.firstChild;)element.removeChild(element.firstChild);_ajax.default.call([{methodname:"mod_booking_load_pre_booking_page",args:{optionid:optionid,pagenumber:currentbookitpage[optionid]},done:function(res){const jsonobject=JSON.parse(res.json),templates=res.template.split(",");let dataarray=jsonobject;const buttontype=res.buttontype;return async function(templates,dataarray,selector){for(const template of templates){console.log("i render first this template, ",template);const data=dataarray.shift();if(!data)return!0;await _templates.default.renderForPromise(template,data.data).then((_ref=>{let{html:html,js:js}=_ref;return console.log("no i append this template, ",template),_templates.default.appendNodeContents(selector,html,js),!0})).catch((ex=>{_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}))}}(templates,dataarray,selector),function(optionid,buttontype){if(console.log(SELECTORS_MODALID+optionid+" "+SELECTORS_INMODALBUTTON),currentbookitpage[optionid]+1<totalbookitpages[optionid]){const element=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_CONTINUEBUTTON);element&&(element.classList.remove("hidden"),1==buttontype&&element.classList.add("disabled"));const inModalButton=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_INMODALBUTTON);inModalButton&&inModalButton.classList.add("hidden")}else{const element=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_CONTINUEBUTTON);if(element&&element.classList.add("hidden"),1==buttontype){const inModalButton=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_INMODALBUTTON);inModalButton&&inModalButton.classList.add("hidden")}else{const inModalButton=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_INMODALBUTTON);inModalButton&&inModalButton.classList.remove("hidden")}}if(currentbookitpage[optionid]>0){const element=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_BACKBUTTON);element&&element.classList.remove("hidden")}else{const element=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_BACKBUTTON);element&&element.classList.add("hidden")}}(optionid,buttontype),!0},fail:function(err){console.log(err)}}])};function toggleContinueButton(optionid){let show=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const continueButton=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_CONTINUEBUTTON),bookingButton=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_BOOKITBUTTON);console.log(bookingButton,optionid,show),continueButton&&disableButton(continueButton,show),bookingButton&&disableButton(bookingButton,show),showBookItButton(optionid,show)}function showBookItButton(optionid,show){const inModalButton=document.querySelector(SELECTORS_MODALID+optionid+" "+SELECTORS_INMODALBUTTON);currentbookitpage[optionid]+1==totalbookitpages[optionid]&&(show?inModalButton.classList.remove("hidden"):inModalButton.classList.add("hidden"))}function disableButton(element,show){console.log(element,show),null===show&&(show=!!element.classList.contains("disabled")),show?element.classList.remove("disabled"):element.classList.add("disabled")}function initializeButton(optionid,back){let selector="";selector=back?SELECTORS_MODALID+optionid+" "+SELECTORS_BACKBUTTON:SELECTORS_MODALID+optionid+" "+SELECTORS_CONTINUEBUTTON;const element=document.querySelector(selector);element&&!element.dataset.prepageinit&&(element.dataset.prepageinit=!0,element.addEventListener("click",(e=>{e.stopPropagation(),element.classList.contains("hidden")||(back?currentbookitpage[optionid]--:currentbookitpage[optionid]++,loadPreBookingPage(optionid))})))}_exports.loadPreBookingPage=loadPreBookingPage}));

//# sourceMappingURL=bookit.min.js.map