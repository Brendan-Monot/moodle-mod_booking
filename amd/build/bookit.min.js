define("mod_booking/bookit",["exports","core/ajax","core/templates","core/notification","local_wunderbyte_table/reload"],(function(_exports,_ajax,_templates,_notification,_reload){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.backToPreviousPage=function(optionid,userid){currentbookitpage[optionid]--,loadPreBookingPage(optionid,userid)},_exports.continueToNextPage=function(optionid,userid){currentbookitpage[optionid]<totalbookitpages[optionid]&&(currentbookitpage[optionid]++,loadPreBookingPage(optionid,userid))},_exports.loadPreBookingPage=_exports.initprepagemodal=_exports.initbookitbutton=void 0,_exports.setBackModalVariables=function(optionid){console.log("setBackModalVariables - optionid: "+optionid+" currentbookitpage[optionid]: "+currentbookitpage[optionid]),currentbookitpage[optionid]=0},_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);var currentbookitpage={},totalbookitpages={},SELECTORS_MODALID="sbPrePageModal_",SELECTORS_INMODALDIV=" div.modalMainContent",SELECTORS_MODALHEADER="div.modalHeader",SELECTORS_MODALBUTTONAREA="div.modalButtonArea",SELECTORS_MODALFOOTER="div.modalFooter",SELECTORS_BOOKITBUTTON="div.booking-button-area.noprice",SELECTORS_STATICBACKDROP="div.modal-backdrop";_exports.initbookitbutton=function initbookitbutton(itemid,area){var initselector=SELECTORS_BOOKITBUTTON+"[data-itemid][data-area]";if(itemid&&area){var selector=SELECTORS_BOOKITBUTTON+'[data-itemid="'+itemid+'"][data-area="'+area+'"]',buttons=document.querySelectorAll(selector);buttons&&buttons.forEach((function(button){if(!button.dataset.nojs&&!button.dataset.initialized){button.dataset.initialized="true";var userid=button.dataset.userid;button.addEventListener("click",(function(e){e.target.classList.contains("btn")&&function(itemid,area,userid){_ajax.default.call([{methodname:"mod_booking_bookit",args:{itemid:itemid,area:area,userid:userid},done:function(res){var jsonarray=JSON.parse(res.json),templates=res.template.split(","),buttons=document.querySelectorAll(SELECTORS_BOOKITBUTTON+"[data-itemid='"+itemid+"'][data-area='"+area+"']"),promises=[];console.log("buttons:",buttons),buttons.forEach((function(button){var arraytoreduce=_toConsumableArray(jsonarray);templates.forEach((function(template){var data=arraytoreduce.shift();if(console.log("data (arraytoreduce): ",data),"mod_booking/bookingpage/prepagemodal"!==template||!button.parentElement.classList.contains("in-modal-button")){var _data$data,datatorender=null!==(_data$data=data.data)&&void 0!==_data$data?_data$data:data,promise=_templates.default.renderForPromise(template,datatorender).then((function(_ref){var html=_ref.html,js=_ref.js;return _templates.default.replaceNode(button,html,js),!0})).catch((function(ex){_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}));promises.push(promise)}}))})),Promise.all(promises).then((function(){return document.querySelector(SELECTORS_STATICBACKDROP)||(0,_reload.reloadAllTables)(),!0})).catch((function(e){console.log(e)}))}}])}(itemid,area,userid)}))}}))}else{document.querySelectorAll(initselector).forEach((function(button){var inititemid=button.dataset.itemid,initarea=button.dataset.area;initbookitbutton(inititemid,initarea)}))}};function isHidden(el){var style=window.getComputedStyle(el);return"none"===style.display||"hidden"===style.visibility}_exports.initprepagemodal=function initprepagemodal(optionid,userid,totalnumberofpages,uniquid){(console.log("initprepagemodal",optionid,userid,totalnumberofpages,uniquid),optionid&&uniquid&&totalnumberofpages)?(currentbookitpage[optionid]=0,totalbookitpages[optionid]=totalnumberofpages,function(optionid,userid,uniquid,totalnumberofpages,callback){console.log("respondToVisibility",optionid,totalnumberofpages,uniquid);var elements=document.querySelectorAll("[id^="+SELECTORS_MODALID+optionid+"_"+uniquid+"]");console.log("elements","[id^="+SELECTORS_MODALID+optionid+"_"+uniquid+"]",elements),elements.forEach((function(element){if(element&&"true"!=element.dataset.initialized){element.dataset.initialized=!0;for(var observer=new MutationObserver((function(){isHidden(element)||callback(optionid,userid,uniquid,totalnumberofpages)}));null!==element;){if(isHidden(element)){if(element.dataset.observed)return;return observer.observe(element,{attributes:!0}),void(element.dataset.observed=!0)}element=element.parentElement}callback(optionid,userid,uniquid,totalnumberofpages)}}))}(optionid,userid,uniquid,totalnumberofpages,loadPreBookingPage)):document.querySelectorAll("[id^="+SELECTORS_MODALID).forEach((function(element){optionid=element.dataset.optionid,uniquid=element.dataset.uniquid,userid=element.dataset.userid,totalnumberofpages=element.dataset.pages,optionid&&uniquid&&initprepagemodal(optionid,userid,totalnumberofpages,uniquid)}))};var loadPreBookingPage=function(optionid){var userid=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,uniquid=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";console.log("loadPreBookingPage",optionid,uniquid,userid);var element=returnVisibleElement(optionid,uniquid,SELECTORS_INMODALDIV);if(element)for(;element.firstChild;)element.removeChild(element.firstChild);else console.error("didnt find element");_ajax.default.call([{methodname:"mod_booking_load_pre_booking_page",args:{optionid:optionid,userid:userid,pagenumber:currentbookitpage[optionid]},done:function(res){console.log(currentbookitpage[optionid],totalbookitpages[optionid]),currentbookitpage[optionid]===totalbookitpages[optionid]-1&&(currentbookitpage[optionid]=0);var jsonobject=JSON.parse(res.json);return renderTemplatesOnPage(res.template.split(","),jsonobject,element),!0},fail:function(err){console.log(err)}}])};function renderTemplatesOnPage(_x,_x2,_x3){return _renderTemplatesOnPage.apply(this,arguments)}function _renderTemplatesOnPage(){return _renderTemplatesOnPage=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(templates,dataarray,element){var modal;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return console.log("templates: ",templates),(modal=element.closest(".modal-body")).querySelector(SELECTORS_MODALHEADER).innerHTML="",modal.querySelector(SELECTORS_INMODALDIV).innerHTML="",modal.querySelector(SELECTORS_MODALBUTTONAREA).innerHTML="",modal.querySelector(SELECTORS_MODALFOOTER).innerHTML="",templates.forEach(function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee(template){var data,targetelement;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(data=dataarray.shift(),console.log("data: ",data),targetelement=element,data){_context.next=5;break}return _context.abrupt("return",!0);case 5:_context.t0=template,_context.next="mod_booking/bookingpage/header"===_context.t0?8:"mod_booking/bookit_button"===_context.t0||"mod_booking/bookit_price"===_context.t0?10:"mod_booking/bookingpage/footer"===_context.t0?12:14;break;case 8:return targetelement=modal.querySelector(SELECTORS_MODALHEADER),_context.abrupt("break",16);case 10:return targetelement=modal.querySelector(SELECTORS_MODALBUTTONAREA),_context.abrupt("break",16);case 12:return targetelement=modal.querySelector(SELECTORS_MODALFOOTER),_context.abrupt("break",16);case 14:return targetelement=modal.querySelector(SELECTORS_INMODALDIV),_context.abrupt("break",16);case 16:return console.log("data.data: ",data.data),_context.next=19,_templates.default.renderForPromise(template,data.data).then((function(_ref3){var html=_ref3.html,js=_ref3.js;return console.log("targetelement: ",targetelement),_templates.default.replaceNodeContents(targetelement,html,js),!0})).catch((function(ex){_notification.default.addNotification({message:"failed rendering "+ex,type:"danger"})}));case 19:return _context.abrupt("return",!0);case 20:case"end":return _context.stop()}}),_callee)})));return function(_x4){return _ref2.apply(this,arguments)}}()),_context2.abrupt("return",!0);case 8:case"end":return _context2.stop()}}),_callee2)}))),_renderTemplatesOnPage.apply(this,arguments)}function returnVisibleElement(optionid,uniquid,appendedSelector){var selector="[id^="+SELECTORS_MODALID+optionid+"_"+uniquid+"] "+appendedSelector;uniquid&&0!==uniquid.length||(selector="[id^="+SELECTORS_MODALID+optionid+"].show "+appendedSelector);var elements=document.querySelectorAll(selector),visibleElement=null;return elements.forEach((function(element){console.log("visibleElement",selector,element),visibleElement=element})),visibleElement}_exports.loadPreBookingPage=loadPreBookingPage}));

//# sourceMappingURL=bookit.min.js.map