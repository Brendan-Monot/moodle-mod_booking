{"version":3,"file":"prepageFooter.min.js","sources":["../src/prepageFooter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/prepageFooter\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport jQuery from 'jquery';\nimport {continueToNextPage, backToPreviousPage, setBackModalVariables} from 'mod_booking/bookit';\nimport {reloadAllTables} from 'local_wunderbyte_table/reload';\n\nvar SELECTORS = {\n    MODALID: 'sbPrePageModal_',\n    INMODALDIV: ' div.modalMainContent',\n    INMODALFOOTER: ' div.prepage-booking-footer',\n    INMODALBUTTON: 'div.in-modal-button',\n    BOOKITBUTTON: 'div.booking-button-area',\n    STATICBACKDROP: 'div.modal-backdrop',\n};\n\n/* Const WAITTIME = 1500;*/\n\n/**\n * Add the click listener to a prepage modal button.\n * @param {integer} optionid\n * @param {integer} userid\n */\nexport function initFooterButtons(optionid, userid) {\n\n    // Everytime we close the modal, we want to reset to the first prepage.\n    jQuery.each(jQuery(\"[id^=\" + SELECTORS.MODALID + optionid + \"]\"), function() {\n        jQuery(this).on(\"hide.bs.modal\", function() {\n            setBackModalVariables(optionid);\n        });\n    });\n\n    initBookingButton(optionid);\n\n    // First, get all link elements in the footer.\n    const elements = document.querySelectorAll(\"[id^=\" + SELECTORS.MODALID + optionid + \"] \" + SELECTORS.INMODALFOOTER + \" a\");\n\n    // eslint-disable-next-line no-console\n    console.log('elements', elements);\n\n    elements.forEach(element => {\n        if (element && !element.dataset.initialized) {\n\n            // Make sure we dont initialize this twice.\n            element.dataset.initialized = true;\n\n            element.addEventListener('click', () => {\n\n                if (element.classList.contains('hidden')) {\n                    return;\n                }\n\n                // The logic might be blocked because eg a form is there to prevent it.\n                if (element.dataset.blocked == 'true') {\n                    return;\n                }\n\n                const action = element.dataset.action;\n\n                switch (action) {\n                    case 'back':\n                        backToPreviousPage(optionid, userid);\n                    break;\n                    case 'continue':\n                        continueToNextPage(optionid, userid);\n                    break;\n                    case 'checkout':\n                        closeModal(optionid);\n                        window.location.href = element.dataset.href;\n                    break;\n                    case 'closemodal':\n                        closeModal(optionid);\n                    break;\n                }\n            });\n        }\n    });\n}\n\n/**\n *\n * @param {int} optionid\n */\nasync function initBookingButton(optionid) {\n\n    // eslint-disable-next-line no-console\n    console.log('initBookingButton');\n\n    // First, we get the right modal.\n    let modal = document.querySelector(\"div.modal.show[id^=\" + SELECTORS.MODALID + optionid + \"]\");\n\n    if (!modal) {\n        return;\n    }\n\n    modal.addEventListener('click', (e) => {\n\n        // eslint-disable-next-line no-console\n        console.log('click on modal', e.target);\n\n        let button = e.target;\n\n        if (button) {\n\n            const bookingButtonArea = e.target.closest(SELECTORS.BOOKITBUTTON);\n\n            button = e.target.closest('.btn');\n\n            if (bookingButtonArea && button) {\n                // eslint-disable-next-line no-console\n                console.log('initBookingButton click');\n\n                if ((bookingButtonArea.dataset.action == 'noforward')) {\n                    return;\n                }\n\n                // There are several bugs caused by automatic forwarding, so we comment it out for now.\n                // We don't continue right away but wait for a second.\n                /* setTimeout(() => {\n                    continueToNextPage(optionid);\n                }, WAITTIME);*/\n            }\n        }\n    });\n}\n\n/**\n *\n * @param {int} optionid\n */\nfunction closeModal(optionid) {\n\n    jQuery.each(jQuery(\"[id^=\" + SELECTORS.MODALID + optionid + \"]\"), function() {\n        jQuery(this).modal('hide');\n        reloadAllTables();\n    });\n}"],"names":["obj","optionid","userid","jQuery","each","SELECTORS","MODALID","this","on","setBackModalVariables","async","console","log","modal","document","querySelector","addEventListener","e","target","button","bookingButtonArea","closest","BOOKITBUTTON","dataset","action","initBookingButton","elements","querySelectorAll","INMODALFOOTER","forEach","element","initialized","classList","contains","blocked","backToPreviousPage","continueToNextPage","closeModal","window","location","href","_jquery","__esModule","default","INMODALDIV","INMODALBUTTON","STATICBACKDROP","reloadAllTables"],"mappings":"yJAoB4B,IAAAA;;;;;wFAoBrB,SAA2BC,SAAUC,QAGxCC,QAAAA,QAAOC,MAAK,EAAAD,QAAAA,SAAO,QAAUE,UAAUC,QAAUL,SAAW,MAAM,YAC9D,EAAAE,QAAAA,SAAOI,MAAMC,GAAG,iBAAiB,YAC7B,EAAAC,QAAAA,uBAAsBR,SAC1B,GACJ,IAqDJS,eAAiCT,UAG7BU,QAAQC,IAAI,qBAGZ,IAAIC,MAAQC,SAASC,cAAc,sBAAwBV,UAAUC,QAAUL,SAAW,KAE1F,IAAKY,MACD,OAGJA,MAAMG,iBAAiB,SAAUC,IAG7BN,QAAQC,IAAI,iBAAkBK,EAAEC,QAEhC,IAAIC,OAASF,EAAEC,OAEf,GAAIC,OAAQ,CAER,MAAMC,kBAAoBH,EAAEC,OAAOG,QAAQhB,UAAUiB,cAIrD,GAFAH,OAASF,EAAEC,OAAOG,QAAQ,QAEtBD,mBAAqBD,SAErBR,QAAQC,IAAI,2BAE6B,aAApCQ,kBAAkBG,QAAQC,QAC3B,MASZ,IAER,CA5FIC,CAAkBxB,UAGlB,MAAMyB,SAAWZ,SAASa,iBAAiB,QAAUtB,UAAUC,QAAUL,SAAW,KAAOI,UAAUuB,cAAgB,MAGrHjB,QAAQC,IAAI,WAAYc,UAExBA,SAASG,SAAQC,UACTA,UAAYA,QAAQP,QAAQQ,cAG5BD,QAAQP,QAAQQ,aAAc,EAE9BD,QAAQd,iBAAiB,SAAS,KAE9B,GAAIc,QAAQE,UAAUC,SAAS,UAC3B,OAIJ,GAA+B,QAA3BH,QAAQP,QAAQW,QAChB,OAKJ,OAFeJ,QAAQP,QAAQC,QAG3B,IAAK,QACD,EAAAW,QAAkBA,oBAAClC,SAAUC,QACjC,MACA,IAAK,YACD,EAAAkC,QAAkBA,oBAACnC,SAAUC,QACjC,MACA,IAAK,WACDmC,WAAWpC,UACXqC,OAAOC,SAASC,KAAOV,QAAQP,QAAQiB,KAC3C,MACA,IAAK,aACDH,WAAWpC,UAEnB,IAER,GAER,EA1EAwC,SAA4BzC,IAA5ByC,UAA4BzC,IAAA0C,WAAA1C,IAAA2C,CAAAA,QAAA3C,KAI5B,IAAIK,UAAY,CACZC,QAAS,kBACTsC,WAAY,wBACZhB,cAAe,8BACfiB,cAAe,sBACfvB,aAAc,0BACdwB,eAAgB,sBAqHpB,SAAST,WAAWpC,UAEhBE,QAAAA,QAAOC,MAAK,EAAAD,QAAAA,SAAO,QAAUE,UAAUC,QAAUL,SAAW,MAAM,YAC9D,EAAAE,QAAAA,SAAOI,MAAMM,MAAM,SACnB,EAAAkC,QAAAA,kBACJ,GACJ,CAAC"}